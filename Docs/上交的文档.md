# 上交文档

# 组建队伍
团队协作学创课，首要的是组建团队。
![组队时序图](https://raw.githubusercontent.com/bllli/ReverseCourse/new/Docs/%E5%AD%A6%E7%94%9F%E5%9B%A2%E9%98%9F%E7%BB%84%E5%BB%BA%E6%97%B6%E5%BA%8F.png)

可以看出，申请创建部分可以使用表单提交，而通知和邀请是两个难点

## 邀请/申请
这种机制的本质就是A要求B干啥事，B接受信息选择同意或者不同意。

- 用户(团队队长) 邀请 其他用户 进入 XX小队
- 用户(课程负责教师) 邀请 其他用户(教师) 进入 XX课程教师团队
- 用户(团队成员) 向用户(团队队长) 申请 加入 XX小队
- 用户(团队成员) 向用户(团队队长) 申请 退出 XX小队

由于种类繁多，关系复杂，我们将邀请、申请行为通过数据库持久化，以便在未来核验用户接受邀请的真实性，拒绝处理用户伪造的请求。

![ER图](https://raw.githubusercontent.com/bllli/ReverseCourse/new/Docs/ER1125.png)

```python
class Invite(models.Model):
    INVITE_USER_JOIN_GROUP = 1  # (团队队长)邀请(教师)加入团队
    INVITE_TEACHER_JOIN_COURSE = 2  # (课程负责人)邀请(其他教师)加入课程
    APPLY_JOIN_GROUP = 3  # (普通用户)向(团队队长)申请加入团队
    APPLY_QUIT_GROUP = 4  # (普通用户)向(团队队长)申请退出团队
    INVITE = (INVITE_USER_JOIN_GROUP, INVITE_TEACHER_JOIN_COURSE)  # 邀请
    APPLY = (APPLY_QUIT_GROUP, APPLY_JOIN_GROUP)  # 申请
    TYPE = (
        (INVITE_USER_JOIN_GROUP, '邀请加入团队'),
        (INVITE_TEACHER_JOIN_COURSE, '邀请管理课程'),
        (APPLY_JOIN_GROUP, '申请加入团队'),
        (APPLY_QUIT_GROUP, '申请退出团队'),
    )
    code = models.CharField(max_length=10, verbose_name='邀请码')
    choice = models.IntegerField(choices=TYPE, default=INVITE_USER_JOIN_GROUP)
    creator = models.ForeignKey(User, related_name='send_code_set', verbose_name='邀请人')
    invitee = models.ForeignKey(User, related_name='receive_code_set', verbose_name='受邀人')
    course = models.ForeignKey(Course, related_name='code_set', null=True)
    group = models.ForeignKey(CourseGroup, related_name='code_set', null=True)
    
    def check_code(self, user: User) -> bool:
        """判断使用该邀请码的用户是否有权限"""
        return True if (self.choice is Invite.INVITE_USER_JOIN_GROUP and user == self.invitee) or \
                       (self.choice in Invite.APPLY and user == self.group.creator) or \
                       (self.choice is Invite.INVITE_TEACHER_JOIN_COURSE and user == self.course.author) else False
```
确认邀请对象类型 `if a_invite.choice is Invite.APPLY_QUIT_GROUP:`  
确认邀请对象是申请的一种 `if a_invite.choice in Invite.APPLY:`

check_code方法用于检测某个用户点击确认按钮从而访问链接时，检测该用户是否有权这样做。  
根据设计，邀请只能由受邀请人点击确认，申请只能由队长/教师点击确认。  
如一个普通成员获取了别人入队申请的code，就可以尝试访问`/accept/(code)/`来“批准” 加入队伍的申请。但在系统设计中，只允许队长批准。  
加上了权限检测后，假的真不了，就能验证用户的访问的真实性，保证系统稳定、正常。

## 通知
我们已经生成了请求(申请/邀请)记录，但是怎么把这些记录发送给受邀请人、审核人呢？

我们使用了Django-notification-hq库提供的提醒功能，并以此为基础构建了站内信体系。

将请求信息通过站内信的形式发送给用户
```python
notify.send(request.user, recipient=invitees,
                        verb='邀请你加入<a href="/groups/{g_id}/" target="_blank">{group}</a>'
                        .format(group=group.name, g_id=group.pk),
                        target=group,
                        description=invite_code)
```

![收件箱图片](https://raw.githubusercontent.com/bllli/ReverseCourse/new/Docs/blog_img/%E6%94%B6%E4%BB%B6%E7%AE%B1.png)
